<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Asistencia Personal</title>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <!-- LibrerÃ­as para exportar -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
            background-color: #f5f5f5;
            line-height: 1.6;
            margin: 0;
            padding: 0;
        }

        .header {
            background: linear-gradient(135deg, #2196F3, #1976D2);
            color: white;
            padding: 20px;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
        }

        .header h1 {
            font-size: 24px;
            margin-bottom: 5px;
        }

        .header .fecha {
            opacity: 0.9;
            font-size: 16px;
        }

        .search-container {
            background: white;
            padding: 20px;
            padding-top: 30px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            position: fixed;
            top: 88px;
            left: 0;
            right: 0;
            z-index: 999;
        }

        .search-input {
            width: 100%;
            padding: 12px;
            font-size: 16px;
            border: 2px solid #ddd;
            border-radius: 8px;
            outline: none;
            transition: border-color 0.3s;
        }

        .search-input:focus {
            border-color: #2196F3;
        }

        .content {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            margin-top: 360px;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .persona-card {
            background: white;
            margin-bottom: 15px;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            transition: all 0.3s ease;
        }

        .persona-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.15);
        }

        .persona-info {
            flex: 1;
        }

        .persona-nombre {
            font-size: 18px;
            font-weight: bold;
            color: #333;
            margin-bottom: 5px;
        }

        .persona-detalles {
            color: #666;
            margin-bottom: 3px;
        }

        .persona-hora {
            color: #4CAF50;
            font-weight: 500;
            font-size: 14px;
        }

        .btn-check {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn-check:hover {
            background: #45a049;
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }

        .btn-undo {
            background: #FF9800;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-undo:hover {
            background: #f57c00;
        }

        .tabs {
            display: flex;
            background: white;
            margin-bottom: 0;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            position: fixed;
            top: 178px;
            left: 0;
            right: 0;
            z-index: 998;
        }

        .tab {
            flex: 1;
            padding: 15px;
            text-align: center;
            border: none;
            background: #f5f5f5;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: all 0.3s;
        }

        .tab.active {
            background: #2196F3;
            color: white;
        }

        .export-buttons {
            display: flex;
            gap: 10px;
            padding: 10px;
            background: white;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            position: fixed;
            top: 238px;
            left: 0;
            right: 0;
            z-index: 996;
            justify-content: center;
        }

        .btn-export {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .btn-export:hover {
            background: #45a049;
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .stats {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            padding: 15px;
            background: white;
            border-radius: 0;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            position: fixed;
            top: 288px;
            left: 0;
            right: 0;
            z-index: 997;
        }

        .stat-card {
            flex: 1;
            text-align: center;
        }

        .stat-number {
            font-size: 24px;
            font-weight: bold;
            color: #2196F3;
        }

        .stat-label {
            color: #666;
            font-size: 14px;
        }

        .alert {
            background: #4CAF50;
            color: white;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            text-align: center;
            display: none;
            position: fixed;
            top: 348px;
            left: 20px;
            right: 20px;
            z-index: 1001;
            max-width: 760px;
            margin-left: auto;
            margin-right: auto;
        }

        .alert.error {
            background: #F44336;
        }

        .alert.info {
            background: #2196F3;
        }

        @media (max-width: 600px) {
            .persona-card {
                flex-direction: column;
                align-items: stretch;
                text-align: center;
            }

            .persona-info {
                margin-bottom: 15px;
            }

            .botones {
                justify-content: center;
            }

            .content {
                margin-top: 400px;
                padding: 10px;
            }

            .search-container {
                padding: 15px;
                padding-top: 25px;
                top: 88px;
            }

            .tabs {
                top: 168px;
            }

            .export-buttons {
                top: 228px;
                padding: 8px;
            }

            .stats {
                top: 278px;
                padding: 10px;
            }

            .alert {
                top: 338px;
                left: 10px;
                right: 10px;
                max-width: none;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>Asistencia Personal</h1>
        <div class="fecha" id="fecha"></div>
    </div>

    <div class="search-container">
        <input 
            type="text" 
            class="search-input" 
            id="searchInput"
            placeholder="Buscar por nombre, rango o cÃ©dula..."
        >
    </div>

    <div class="tabs">
        <button class="tab active" onclick="cambiarTab('pendientes')">
            Por Pasar Lista (<span id="countPendientes">0</span>)
        </button>
        <button class="tab" onclick="cambiarTab('presentes')">
            Presentes (<span id="countPresentes">0</span>)
        </button>
    </div>

    <div class="export-buttons">
        <button class="btn-export" onclick="exportarPDF()">ðŸ“„ Exportar PDF</button>
        <button class="btn-export" onclick="exportarExcel()">ðŸ“Š Exportar Excel</button>
    </div>

    <div class="content">
        <div class="stats">
            <div class="stat-card">
                <div class="stat-number" id="totalPersonal">0</div>
                <div class="stat-label">Total Personal</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="totalPresentes">0</div>
                <div class="stat-label">Presentes</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="porcentajeAsistencia">0%</div>
                <div class="stat-label">% Asistencia</div>
            </div>
        </div>

        <div class="alert" id="alert"></div>

        <div class="loading" id="loading">
            Cargando personal...
        </div>

        <!-- Tab: Personal pendiente por pasar lista -->
        <div id="tab-pendientes" class="tab-content active">
            <div id="personalPendienteContainer"></div>
        </div>

        <!-- Tab: Personal presente -->
        <div id="tab-presentes" class="tab-content">
            <div id="personalPresenteContainer"></div>
        </div>
    </div>

    <script>
        // ConfiguraciÃ³n de Supabase
        const supabaseUrl = 'https://sssupabasess.coman2uniformes.com';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.ewogICJyb2xlIjogImFub24iLAogICJpc3MiOiAic3VwYWJhc2UiLAogICJpYXQiOiAxNzE1MDUwODAwLAogICJleHAiOiAxODcyODE3MjAwCn0.vGcSPMihrp1q9HoEM-0f8LuoP-AmqurAPWxu_qpfThk';
        
        // Configurar Supabase con opciones adicionales
        const supabaseOptions = {
            auth: {
                autoRefreshToken: false,
                persistSession: false
            }
        };
        
        const supabase = window.supabase.createClient(supabaseUrl, supabaseKey, supabaseOptions);

        let personal = [];
        let asistencias = {};
        let tabActual = 'pendientes';
        const fechaHoy = new Date().toISOString().split('T')[0];

        // Orden de instituciones
        const ordenInstituciones = {
            'ERD': 1,
            'ARD': 2, 
            'FARD': 3,
            'PN': 4
        };

        // Orden de rangos (menor nÃºmero = mayor jerarquÃ­a)
        const ordenRangos = {
            'MAYOR GENERAL': 1,
            'GENERAL DE BRIGADA': 2,
            'CORONEL': 3,
            'CAPITÃN DE NAVIO': 4,
            'TENIENTE CORONEL': 5,
            'CAPITÃN DE FRAGATA': 6,
            'MAYOR': 7,
            'CAPITÃN DE CORBETA': 8,
            'CAPITÃN': 9,
            'TENIENTE DE NAVIO': 10,
            '1ER. TENIENTE': 11,
            'TTE. DE FRAGATA': 12,
            '2DO.TENIENTE': 13,
            'TTE. DE CORBETA': 14,
            'SARGENTO MAYOR': 15,
            'SARGENTO': 16,
            'CABO': 17,
            'RASO': 18,
            'MARINERO': 19,
            'ASIMILADO MILITAR': 20,
            'ASIMILADO': 21,
            'CIVIL': 22
        };

        // Inicializar app
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('fecha').textContent = new Date().toLocaleDateString('es-ES', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });

            cargarDatos();
            
            // Debounce para la bÃºsqueda
            let timeoutBusqueda;
            document.getElementById('searchInput').addEventListener('input', function() {
                clearTimeout(timeoutBusqueda);
                timeoutBusqueda = setTimeout(filtrarPersonal, 200);
            });
        });

        async function cargarDatos() {
            try {
                console.log('Conectando a Supabase...');
                // mostrarAlerta('Conectando a la base de datos...', 'info');
                
                // Prueba de conectividad bÃ¡sica
                console.log('URL de Supabase:', supabaseUrl);
                console.log('Cliente Supabase configurado:', !!supabase);
                
                // Cargar datos secuencialmente para asegurar orden correcto
                await cargarPersonal();
                await cargarAsistencias();
                
                // Verificar que los datos se cargaron correctamente
                console.log('Personal cargado:', personal.length);
                console.log('Asistencias cargadas:', Object.keys(asistencias).length);
                
                // Renderizar solo despuÃ©s de que ambos estÃ©n listos
                actualizarEstadisticas();
                renderizarTabs();
                
                console.log('Datos cargados exitosamente');
                // mostrarAlerta('Datos cargados correctamente', 'success');
            } catch (error) {
                console.error('Error:', error);
                mostrarAlerta('Error al cargar los datos: ' + error.message, 'error');
                document.getElementById('loading').innerHTML = 'Error de conexiÃ³n. Revisa la consola del navegador.';
            }
        }

        async function cargarPersonal() {
            console.log('Cargando personal...');
            const { data, error } = await supabase
                .from('seguridad_dinamica')
                .select('*');
            
            if (error) {
                console.error('Error al cargar personal:', error);
                throw error;
            }
            
            // Ordenar personal segÃºn criterios
            personal = (data || []).sort(compararPersonal);
            console.log('Personal cargado y ordenado:', personal.length, 'personas');
        }

        function compararPersonal(a, b) {
            // 1. Primero por instituciÃ³n
            const instA = ordenInstituciones[a['INST.']] || 999;
            const instB = ordenInstituciones[b['INST.']] || 999;
            
            if (instA !== instB) {
                return instA - instB;
            }
            
            // 2. Luego por rango
            const rangoA = ordenRangos[a.RANGO?.toUpperCase()] || 999;
            const rangoB = ordenRangos[b.RANGO?.toUpperCase()] || 999;
            
            if (rangoA !== rangoB) {
                return rangoA - rangoB;
            }
            
            // 3. Finalmente por apellidos
            return (a.APELLIDOS || '').localeCompare(b.APELLIDOS || '');
        }

        async function cargarAsistencias() {
            console.log('Cargando asistencias para fecha:', fechaHoy);
            const { data, error } = await supabase
                .from('asistencias')
                .select('*')
                .eq('fecha', fechaHoy);
            
            if (error) {
                console.error('Error al cargar asistencias:', error);
                throw error;
            }
            
            // Reiniciar objeto de asistencias
            asistencias = {};
            
            // Mapear asistencias por personal_id
            data?.forEach(asistencia => {
                asistencias[asistencia.personal_id] = asistencia;
            });
            
            console.log('Asistencias cargadas:', Object.keys(asistencias).length, 'registros');
        }

        function cambiarTab(tab) {
            tabActual = tab;
            
            // Actualizar botones de tabs
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelector(`[onclick="cambiarTab('${tab}')"]`).classList.add('active');
            
            // Mostrar/ocultar contenido
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            document.getElementById(`tab-${tab}`).classList.add('active');
            
            renderizarTabs();
        }

        function filtrarPersonal() {
            renderizarTabs();
        }

        function renderizarTabs() {
            const busqueda = document.getElementById('searchInput').value.toLowerCase();
            document.getElementById('loading').style.display = 'none';
            
            console.log('Renderizando tabs...');
            console.log('Personal total:', personal.length);
            console.log('Asistencias:', Object.keys(asistencias).length);
            
            // Filtrar personal
            const personalFiltrado = personal.filter(persona =>
                persona.APELLIDOS?.toLowerCase().includes(busqueda) ||
                persona.NOMBRES?.toLowerCase().includes(busqueda) ||
                persona.RANGO?.toLowerCase().includes(busqueda) ||
                persona.CÃ‰DULA?.includes(busqueda)
            );
            
            // Separar en pendientes y presentes y ordenar
            const pendientes = personalFiltrado
                .filter(persona => !asistencias[persona.id]?.presente)
                .sort(compararPersonal);
                
            const presentes = personalFiltrado
                .filter(persona => asistencias[persona.id]?.presente)
                .sort(compararPersonal);
            
            console.log('Pendientes:', pendientes.length);
            console.log('Presentes:', presentes.length);
            
            // Actualizar contadores en tabs
            document.getElementById('countPendientes').textContent = pendientes.length;
            document.getElementById('countPresentes').textContent = presentes.length;
            
            // Renderizar cada tab
            renderizarPersonalPendiente(pendientes);
            renderizarPersonalPresente(presentes);
        }

        function renderizarPersonalPendiente(personalData) {
            const container = document.getElementById('personalPendienteContainer');
            
            if (personalData.length === 0) {
                container.innerHTML = '<div style="text-align: center; padding: 40px; color: #666;">âœ… Â¡Todos han pasado lista!</div>';
                return;
            }

            container.innerHTML = personalData.map(persona => `
                <div class="persona-card">
                    <div class="persona-info">
                        <div class="persona-nombre">
                            ${persona.RANGO} ${persona.APELLIDOS}, ${persona.NOMBRES}
                        </div>
                        <div class="persona-detalles">
                            ${persona['INST.'] || 'Sin instituciÃ³n'} â€¢ CÃ©dula: ${persona.CÃ‰DULA}
                        </div>
                    </div>
                    <button 
                        class="btn-check"
                        onclick="marcarPresente(${persona.id})"
                    >
                        âœ“ Presente
                    </button>
                </div>
            `).join('');
        }

        function renderizarPersonalPresente(personalData) {
            const container = document.getElementById('personalPresenteContainer');
            
            if (personalData.length === 0) {
                container.innerHTML = '<div style="text-align: center; padding: 40px; color: #666;">AÃºn no hay personal presente</div>';
                return;
            }

            container.innerHTML = personalData.map(persona => {
                const asistencia = asistencias[persona.id];
                return `
                    <div class="persona-card">
                        <div class="persona-info">
                            <div class="persona-nombre">
                                ${persona.RANGO} ${persona.APELLIDOS}, ${persona.NOMBRES}
                            </div>
                            <div class="persona-detalles">
                                ${persona['INST.'] || 'Sin instituciÃ³n'} â€¢ CÃ©dula: ${persona.CÃ‰DULA}
                            </div>
                            <div class="persona-hora">
                                âœ… Entrada: ${asistencia.hora_entrada}
                            </div>
                        </div>
                        <button 
                            class="btn-undo"
                            onclick="desmarcarPresente(${persona.id})"
                            title="Quitar de presentes"
                        >
                            Deshacer
                        </button>
                    </div>
                `;
            }).join('');
        }

        async function marcarPresente(personalId) {
            const persona = personal.find(p => p.id === personalId);
            if (!persona) return;
            
            const horaActual = new Date().toTimeString().split(' ')[0];
            
            // Encontrar y ocultar el elemento inmediatamente
            const elemento = document.querySelector(`[onclick="marcarPresente(${personalId})"]`).closest('.persona-card');
            elemento.style.transform = 'translateX(-100%)';
            elemento.style.opacity = '0';
            
            // Actualizar datos locales
            asistencias[personalId] = {
                personal_id: personalId,
                fecha: fechaHoy,
                presente: true,
                hora_entrada: horaActual,
                id: asistencias[personalId]?.id
            };
            
            // Actualizar contadores inmediatamente
            actualizarContadoresRapido();
            // mostrarAlerta(`âœ… ${persona.APELLIDOS}, ${persona.NOMBRES} marcado presente`, 'success');
            
            // Remover elemento despuÃ©s de la animaciÃ³n
            setTimeout(() => {
                elemento.remove();
                // Solo actualizar el tab de presentes
                if (tabActual === 'presentes') {
                    agregarAPresentes(persona, horaActual);
                }
            }, 300);
            
            // Guardar en background sin await para no bloquear
            guardarAsistenciaBackground(personalId, true, horaActual);
        }

        async function desmarcarPresente(personalId) {
            const persona = personal.find(p => p.id === personalId);
            const asistencia = asistencias[personalId];
            if (!asistencia) {
                console.log('No hay asistencia para eliminar');
                return;
            }
            
            console.log('Desmarcando presente:', personalId, 'ID de asistencia:', asistencia.id);
            
            // Animar y remover elemento
            const elemento = document.querySelector(`[onclick="desmarcarPresente(${personalId})"]`).closest('.persona-card');
            elemento.style.transform = 'translateX(100%)';
            elemento.style.opacity = '0';
            
            // Actualizar datos locales
            delete asistencias[personalId];
            
            // Actualizar contadores
            actualizarContadoresRapido();
            // mostrarAlerta(`ðŸ”„ ${persona.APELLIDOS}, ${persona.NOMBRES} regresado a lista pendiente`, 'success');
            
            // Remover elemento despuÃ©s de la animaciÃ³n
            setTimeout(() => {
                elemento.remove();
                // Solo actualizar el tab de pendientes si estÃ¡ activo
                if (tabActual === 'pendientes') {
                    agregarAPendientes(persona);
                }
            }, 300);
            
            // Eliminar de la base de datos (hacer await para asegurar que se elimine)
            try {
                if (asistencia.id) {
                    console.log('Eliminando asistencia ID:', asistencia.id);
                    const resultado = await supabase
                        .from('asistencias')
                        .delete()
                        .eq('id', asistencia.id);
                    
                    if (resultado.error) {
                        console.error('Error al eliminar asistencia:', resultado.error);
                        // mostrarAlerta('Error al eliminar asistencia: ' + resultado.error.message, 'error');
                    } else {
                        console.log('Asistencia eliminada exitosamente de la BD');
                    }
                } else {
                    console.log('No hay ID de asistencia para eliminar');
                }
            } catch (error) {
                console.error('Error al eliminar:', error);
                // mostrarAlerta('Error al eliminar asistencia', 'error');
            }
        }

        async function guardarAsistenciaBackground(personalId, presente, horaActual) {
            try {
                const asistenciaExistente = asistencias[personalId];
                
                if (asistenciaExistente?.id) {
                    await supabase
                        .from('asistencias')
                        .update({
                            presente: presente,
                            hora_entrada: horaActual
                        })
                        .eq('id', asistenciaExistente.id);
                } else {
                    const resultado = await supabase
                        .from('asistencias')
                        .upsert({
                            personal_id: personalId,
                            fecha: fechaHoy,
                            presente: presente,
                            hora_entrada: horaActual
                        }, {
                            onConflict: 'personal_id,fecha'
                        })
                        .select();
                    
                    if (resultado.data && resultado.data[0]) {
                        asistencias[personalId].id = resultado.data[0].id;
                    }
                }
            } catch (error) {
                console.error('Error al guardar:', error);
            }
        }

        function actualizarContadoresRapido() {
            const totalPersonal = personal.length;
            const presentes = Object.values(asistencias).filter(a => a.presente === true).length;
            const pendientes = totalPersonal - presentes;
            const porcentaje = totalPersonal > 0 ? Math.round((presentes / totalPersonal) * 100) : 0;
            
            document.getElementById('countPendientes').textContent = pendientes;
            document.getElementById('countPresentes').textContent = presentes;
            document.getElementById('totalPersonal').textContent = totalPersonal;
            document.getElementById('totalPresentes').textContent = presentes;
            document.getElementById('porcentajeAsistencia').textContent = porcentaje + '%';
        }

        function agregarAPresentes(persona, horaActual) {
            const container = document.getElementById('personalPresenteContainer');
            
            // Crear nuevo elemento
            const nuevoElemento = document.createElement('div');
            nuevoElemento.className = 'persona-card';
            nuevoElemento.style.transform = 'translateX(100%)';
            nuevoElemento.style.opacity = '0';
            nuevoElemento.innerHTML = `
                <div class="persona-info">
                    <div class="persona-nombre">
                        ${persona.RANGO} ${persona.APELLIDOS}, ${persona.NOMBRES}
                    </div>
                    <div class="persona-detalles">
                        ${persona['INST.'] || 'Sin instituciÃ³n'} â€¢ CÃ©dula: ${persona.CÃ‰DULA}
                    </div>
                    <div class="persona-hora">
                        âœ… Entrada: ${horaActual}
                    </div>
                </div>
                <button 
                    class="btn-undo"
                    onclick="desmarcarPresente(${persona.id})"
                    title="Quitar de presentes"
                >
                    Deshacer
                </button>
            `;
            
            // Encontrar posiciÃ³n correcta para insertar ordenadamente
            const elementosExistentes = Array.from(container.children);
            let posicionInsercion = 0;
            
            for (let i = 0; i < elementosExistentes.length; i++) {
                const elemento = elementosExistentes[i];
                const personaIdExistente = elemento.querySelector('.btn-undo').onclick.toString().match(/\d+/)[0];
                const personaExistente = personal.find(p => p.id == personaIdExistente);
                
                if (personaExistente && compararPersonal(persona, personaExistente) < 0) {
                    break;
                }
                posicionInsercion = i + 1;
            }
            
            // Insertar en la posiciÃ³n correcta
            if (posicionInsercion >= elementosExistentes.length) {
                container.appendChild(nuevoElemento);
            } else {
                container.insertBefore(nuevoElemento, elementosExistentes[posicionInsercion]);
            }
            
            // Animar entrada
            setTimeout(() => {
                nuevoElemento.style.transform = 'translateX(0)';
                nuevoElemento.style.opacity = '1';
            }, 50);
        }

        function agregarAPendientes(persona) {
            const container = document.getElementById('personalPendienteContainer');
            
            // Verificar si ya no hay elementos (mensaje de "todos han pasado lista")
            if (container.innerHTML.includes('Â¡Todos han pasado lista!')) {
                container.innerHTML = '';
            }
            
            // Crear nuevo elemento
            const nuevoElemento = document.createElement('div');
            nuevoElemento.className = 'persona-card';
            nuevoElemento.style.transform = 'translateX(-100%)';
            nuevoElemento.style.opacity = '0';
            nuevoElemento.innerHTML = `
                <div class="persona-info">
                    <div class="persona-nombre">
                        ${persona.RANGO} ${persona.APELLIDOS}, ${persona.NOMBRES}
                    </div>
                    <div class="persona-detalles">
                        ${persona['INST.'] || 'Sin instituciÃ³n'} â€¢ CÃ©dula: ${persona.CÃ‰DULA}
                    </div>
                </div>
                <button 
                    class="btn-check"
                    onclick="marcarPresente(${persona.id})"
                >
                    âœ“ Presente
                </button>
            `;
            
            // Encontrar posiciÃ³n correcta para insertar ordenadamente
            const elementosExistentes = Array.from(container.children);
            let posicionInsercion = 0;
            
            for (let i = 0; i < elementosExistentes.length; i++) {
                const elemento = elementosExistentes[i];
                const personaIdExistente = elemento.querySelector('.btn-check').onclick.toString().match(/\d+/)[0];
                const personaExistente = personal.find(p => p.id == personaIdExistente);
                
                if (personaExistente && compararPersonal(persona, personaExistente) < 0) {
                    break;
                }
                posicionInsercion = i + 1;
            }
            
            // Insertar en la posiciÃ³n correcta
            if (posicionInsercion >= elementosExistentes.length) {
                container.appendChild(nuevoElemento);
            } else {
                container.insertBefore(nuevoElemento, elementosExistentes[posicionInsercion]);
            }
            
            // Animar entrada
            setTimeout(() => {
                nuevoElemento.style.transform = 'translateX(0)';
                nuevoElemento.style.opacity = '1';
            }, 50);
        }

        function actualizarEstadisticas() {
            const totalPersonal = personal.length;
            const presentes = Object.values(asistencias).filter(a => a.presente === true).length;
            const porcentaje = totalPersonal > 0 ? Math.round((presentes / totalPersonal) * 100) : 0;
            
            document.getElementById('totalPersonal').textContent = totalPersonal;
            document.getElementById('totalPresentes').textContent = presentes;
            document.getElementById('porcentajeAsistencia').textContent = porcentaje + '%';
        }

        function mostrarAlerta(mensaje, tipo = 'success') {
            const alert = document.getElementById('alert');
            alert.textContent = mensaje;
            alert.className = `alert ${tipo}`;
            alert.style.display = 'block';
            
            if (tipo !== 'info') {
                setTimeout(() => {
                    alert.style.display = 'none';
                }, 3000);
            }
        }

        function obtenerDatosActuales() {
            const busqueda = document.getElementById('searchInput').value.toLowerCase();
            
            // Filtrar personal
            const personalFiltrado = personal.filter(persona =>
                persona.APELLIDOS?.toLowerCase().includes(busqueda) ||
                persona.NOMBRES?.toLowerCase().includes(busqueda) ||
                persona.RANGO?.toLowerCase().includes(busqueda) ||
                persona.CÃ‰DULA?.includes(busqueda)
            );
            
            // Separar en pendientes y presentes
            const pendientes = personalFiltrado
                .filter(persona => !asistencias[persona.id]?.presente)
                .sort(compararPersonal);
                
            const presentes = personalFiltrado
                .filter(persona => asistencias[persona.id]?.presente)
                .sort(compararPersonal);
            
            return { pendientes, presentes };
        }

        function exportarPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            const { pendientes, presentes } = obtenerDatosActuales();
            
            // ConfiguraciÃ³n
            const fechaActual = new Date().toLocaleDateString('es-ES', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
            
            // TÃ­tulo
            doc.setFontSize(18);
            doc.setFont(undefined, 'bold');
            doc.text('Lista de Asistencia Personal', 105, 20, { align: 'center' });
            
            doc.setFontSize(12);
            doc.setFont(undefined, 'normal');
            doc.text(fechaActual, 105, 30, { align: 'center' });
            
            let yPos = 50;
            
            // EstadÃ­sticas
            const totalPersonal = personal.length;
            const totalPresentes = presentes.length;
            const totalPendientes = pendientes.length;
            const porcentaje = totalPersonal > 0 ? Math.round((totalPresentes / totalPersonal) * 100) : 0;
            
            doc.setFontSize(10);
            doc.text(`Total Personal: ${totalPersonal} | Presentes: ${totalPresentes} | Pendientes: ${totalPendientes} | Asistencia: ${porcentaje}%`, 20, yPos);
            yPos += 20;
            
            if (tabActual === 'pendientes' && pendientes.length > 0) {
                // Exportar pendientes
                doc.setFontSize(14);
                doc.setFont(undefined, 'bold');
                doc.text('Personal Pendiente por Pasar Lista', 20, yPos);
                yPos += 10;
                
                const datosPendientes = pendientes.map(persona => [
                    persona.RANGO,
                    `${persona.APELLIDOS}, ${persona.NOMBRES}`,
                    persona['INST.'] || 'Sin instituciÃ³n',
                    persona.CÃ‰DULA
                ]);
                
                doc.autoTable({
                    head: [['Rango', 'Nombre', 'InstituciÃ³n', 'CÃ©dula']],
                    body: datosPendientes,
                    startY: yPos,
                    styles: { fontSize: 8 },
                    headStyles: { fillColor: [33, 150, 243] }
                });
                
            } else if (tabActual === 'presentes' && presentes.length > 0) {
                // Exportar presentes
                doc.setFontSize(14);
                doc.setFont(undefined, 'bold');
                doc.text('Personal Presente', 20, yPos);
                yPos += 10;
                
                const datosPresentes = presentes.map(persona => {
                    const asistencia = asistencias[persona.id];
                    return [
                        persona.RANGO,
                        `${persona.APELLIDOS}, ${persona.NOMBRES}`,
                        persona['INST.'] || 'Sin instituciÃ³n',
                        persona.CÃ‰DULA,
                        asistencia.hora_entrada
                    ];
                });
                
                doc.autoTable({
                    head: [['Rango', 'Nombre', 'InstituciÃ³n', 'CÃ©dula', 'Hora Entrada']],
                    body: datosPresentes,
                    startY: yPos,
                    styles: { fontSize: 8 },
                    headStyles: { fillColor: [76, 175, 80] }
                });
            } else {
                doc.text('No hay datos para exportar en la pestaÃ±a actual', 20, yPos);
            }
            
            // Guardar PDF
            const nombreArchivo = `asistencia_${tabActual}_${new Date().toISOString().split('T')[0]}.pdf`;
            doc.save(nombreArchivo);
            
            mostrarAlerta(`PDF exportado: ${nombreArchivo}`, 'success');
        }

        function exportarExcel() {
            const { pendientes, presentes } = obtenerDatosActuales();
            const fechaActual = new Date().toISOString().split('T')[0];
            
            // Crear libro de trabajo
            const wb = XLSX.utils.book_new();
            
            if (tabActual === 'pendientes' && pendientes.length > 0) {
                // Hoja de pendientes
                const datosPendientes = pendientes.map(persona => ({
                    'Rango': persona.RANGO,
                    'Apellidos': persona.APELLIDOS,
                    'Nombres': persona.NOMBRES,
                    'InstituciÃ³n': persona['INST.'] || 'Sin instituciÃ³n',
                    'CÃ©dula': persona.CÃ‰DULA
                }));
                
                const ws = XLSX.utils.json_to_sheet(datosPendientes);
                XLSX.utils.book_append_sheet(wb, ws, 'Pendientes');
                
            } else if (tabActual === 'presentes' && presentes.length > 0) {
                // Hoja de presentes
                const datosPresentes = presentes.map(persona => {
                    const asistencia = asistencias[persona.id];
                    return {
                        'Rango': persona.RANGO,
                        'Apellidos': persona.APELLIDOS,
                        'Nombres': persona.NOMBRES,
                        'InstituciÃ³n': persona['INST.'] || 'Sin instituciÃ³n',
                        'CÃ©dula': persona.CÃ‰DULA,
                        'Hora Entrada': asistencia.hora_entrada,
                        'Fecha': asistencia.fecha
                    };
                });
                
                const ws = XLSX.utils.json_to_sheet(datosPresentes);
                XLSX.utils.book_append_sheet(wb, ws, 'Presentes');
            } else {
                // Crear hoja vacÃ­a con mensaje
                const ws = XLSX.utils.json_to_sheet([{
                    'Mensaje': 'No hay datos para exportar en la pestaÃ±a actual'
                }]);
                XLSX.utils.book_append_sheet(wb, ws, 'Sin Datos');
            }
            
            // Guardar archivo
            const nombreArchivo = `asistencia_${tabActual}_${fechaActual}.xlsx`;
            XLSX.writeFile(wb, nombreArchivo);
            
            mostrarAlerta(`Excel exportado: ${nombreArchivo}`, 'success');
        }
    </script>
</body>
</html>